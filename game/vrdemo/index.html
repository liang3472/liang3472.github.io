<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VR-Demo</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="flexible" content="initial-dpr=1"/>
    <script src="//github.elemecdn.com/amfe/lib-flexible/master/build/flexible.js"></script>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="//github.elemecdn.com/vuejs/vue/v1.0.15/dist/vue.min.js"></script>
    <script src="https://npmcdn.com/aframe-event-set-component@3.0.1"></script>
    <script src="components/set-image.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <link rel="stylesheet" href="css/mian.css">
</head>
<body id="game">
<video id="video" autoplay></video>
<a-scene>
    <a-assets>
        <img id="egg-nomal" src="res/egg_nomal.png">
        <img id="egg-break" src="res/egg_break.png">
        <img id="city" src="./res/WechatIMG4276.jpeg">
    </a-assets>


    <a-image
            id="hb"
            width="6" height="8"
            src="#egg-nomal"
            position="10 0 -20"
            rotation="0 0 0"
            scale="0.5 0.5 0.5"
            see-cat
            look-controls>
        <a-animation attribute="scale" from="0.9 0.9 0.9" dur="500" to="1 1 1" repeat="reverse"
                     direction="alternate"></a-animation>
        <a-light type="hemisphere" color="#fff">
            <a-animation attribute="intensity" from="1" dur="500" to="1.2" repeat="reverse"
                         direction="alternate"></a-animation>
        </a-light>
    </a-image>

    <!-- 360-degree image. -->
    <!--<a-sky id="image-360" radius="50" src="#city"></a-sky>-->

    <a-camera>
        <a-cursor></a-cursor>
    </a-camera>
</a-scene>
<button class="catch" @click="catchCat()">捉猫猫</button>
</body>
<script>
    var camera;
    var isLookAt = false;
    var videoElement = document.querySelector('video');
    var cat = document.querySelector('a-image');

    function gotDevices(deviceInfos) {
        for (var i = 0; i !== deviceInfos.length; ++i) {
            var deviceInfo = deviceInfos[i];
            if (deviceInfo.kind === 'videoinput') {
                camera = deviceInfo.label;
                console.log('----->' + camera);
            }
        }
    }
    navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);

    function gotStream(stream) {
        window.stream = stream; // make stream available to console
        videoElement.srcObject = stream;
        // Refresh button list in case labels have become available
        return navigator.mediaDevices.enumerateDevices();
    }

    function start() {
        if (window.stream) {
            window.stream.getTracks().forEach(function (track) {
                track.stop();
            });
        }
        var videoSource = camera;
        var constraints = {
            video: {deviceId: videoSource ? {exact: videoSource} : undefined}
        };
        navigator.mediaDevices.getUserMedia(constraints).then(gotStream).then(gotDevices).catch(handleError);
    }

    start();

    function handleError(error) {
        alert('navigator.getUserMedia error: ', error);
    }

    AFRAME.registerComponent('see-cat', {
        init: function () {
            var el = this.el;
            el.addEventListener('mouseenter', function () {
                console.log('焦点锁定');
                isLookAt = true;
            });
            el.addEventListener('mouseleave', function () {
                console.log('焦点解除锁定');
                isLookAt = false;
            });
        }
    });

    new Vue({
        el: '#game',
        methods:{
            catchCat: function () {
                console.log('是否抓到猫：' + isLookAt);
                if(isLookAt){
                    cat.setAttribute('src','#egg-break');
                }
            }
        }
    });

</script>
</html>